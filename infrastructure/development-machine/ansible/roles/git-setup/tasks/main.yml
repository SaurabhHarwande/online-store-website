---
- name: Install Git
  apt:
    name: git
    state: present
    update_cache: yes

- name: Ensure .ssh directory exists
  file:
    path: /root/.ssh
    state: directory
    mode: '0700'

- name: Check if SSH key already exists
  stat:
    path: /root/.ssh/id_ed25519
  register: ssh_key_stat

- name: Generate SSH key for GitHub
  command: ssh-keygen -t ed25519 -C "dev-machine-{{ ansible_hostname }}" -f /root/.ssh/id_ed25519 -N ""
  when: not ssh_key_stat.stat.exists

- name: Read public key
  slurp:
    src: /root/.ssh/id_ed25519.pub
  register: public_key_content

- name: Display public key
  debug:
    msg: "SSH Public Key: {{ public_key_content.content | b64decode }}"

- name: Configure Git global settings
  git_config:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    scope: global
  loop:
    - { name: 'user.name', value: "{{ git_user_name }}" }
    - { name: 'user.email', value: "{{ git_user_email }}" }

- name: Add github.com to known_hosts
  known_hosts:
    name: github.com
    key: "{{ lookup('pipe', 'ssh-keyscan -t rsa github.com') }}"
    path: /root/.ssh/known_hosts
    state: present

- name: Check if SSH key already exists on GitHub
  uri:
    url: https://api.github.com/user/keys
    method: GET
    headers:
      Authorization: "token {{ github_token }}"
      Accept: "application/vnd.github.v3+json"
    return_content: yes
  register: github_ssh_keys
  when: github_token is defined and github_token != ""
  no_log: true

- name: Check if our SSH key is already in the list
  set_fact:
    ssh_key_exists: "{{ github_ssh_keys.json | selectattr('title', 'equalto', 'dev-machine-' + ansible_hostname) | list | length > 0 }}"
  when: github_token is defined and github_token != ""

- name: Add SSH public key to GitHub via API
  uri:
    url: https://api.github.com/user/keys
    method: POST
    headers:
      Authorization: "token {{ github_token }}"
      Accept: "application/vnd.github.v3+json"
    body:
      title: "dev-machine-{{ ansible_hostname }}"
      key: "{{ public_key_content.content | b64decode | trim }}"
    body_format: json
    status_code: 201
  when:
    - github_token is defined and github_token != ""
    - not ssh_key_exists
  no_log: true

- name: Display setup complete message
  debug:
    msg:
      - "Git setup complete!"
      - "SSH key has been generated and added to GitHub"
      - "You can now clone repositories with: git clone git@github.com:username/repo.git"
