---
- name: Install Git
  apt:
    name: git
    state: present
    update_cache: yes

- name: Ensure .ssh directory exists
  file:
    path: /root/.ssh
    state: directory
    mode: '0700'

- name: Check if SSH key already exists
  stat:
    path: /root/.ssh/id_ed25519
  register: ssh_key_stat

- name: Generate SSH key for GitHub
  command: ssh-keygen -t ed25519 -C "cloud-dev-machine" -f /root/.ssh/id_ed25519 -N ""
  when: not ssh_key_stat.stat.exists

- name: Read public key
  slurp:
    src: /root/.ssh/id_ed25519.pub
  register: public_key_content

- name: Display public key
  debug:
    msg: "SSH Public Key: {{ public_key_content.content | b64decode }}"

- name: Configure Git global settings
  git_config:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    scope: global
  loop:
    - { name: 'user.name', value: "{{ git_user_name }}" }
    - { name: 'user.email', value: "{{ git_user_email }}" }

- name: Add github.com to known_hosts
  known_hosts:
    name: github.com
    key: "{{ lookup('pipe', 'ssh-keyscan -t rsa github.com') }}"
    path: /root/.ssh/known_hosts
    state: present

- name: Authenticate GitHub CLI
  shell: echo "{{ github_token }}" | gh auth login --with-token
  when: github_token is defined and github_token != ""
  no_log: true

- name: Check if cloud-dev-machine SSH key exists on GitHub
  shell: gh ssh-key list | grep "cloud-dev-machine" | awk -F'\t' '{print $4}'
  when: github_token is defined and github_token != ""
  register: existing_key_id
  changed_when: false
  failed_when: false

- name: Delete existing cloud-dev-machine SSH key from GitHub
  shell: gh ssh-key delete "{{ existing_key_id.stdout }}" --yes
  when:
    - github_token is defined and github_token != ""
    - existing_key_id.stdout != ""

- name: Add SSH public key to GitHub via API
  uri:
    url: https://api.github.com/user/keys
    method: POST
    headers:
      Authorization: "token {{ github_token }}"
      Accept: "application/vnd.github.v3+json"
    body:
      title: "cloud-dev-machine"
      key: "{{ public_key_content.content | b64decode | trim }}"
    body_format: json
    status_code: 201
  when: github_token is defined and github_token != ""
  no_log: true

- name: Display setup complete message
  debug:
    msg:
      - "Git setup complete!"
      - "SSH key has been generated and added to GitHub"
      - "You can now clone repositories with: git clone git@github.com:username/repo.git"
